angular.module("angularPayments",[]),angular.module("angularPayments").factory("Common",[function(){var e={parseExpiry:function(e){var t,r,n;return t=(n=(e=(e=e||"").replace(/\s/g,"")).split("/",2))[0],(r=n[1])&&2===r.length&&/^\d+$/.test(r)&&(r=(new Date).getFullYear().toString().slice(0,2)+r),{month:t=parseInt(t,10),year:r=parseInt(r,10)}}};return e}]),angular.module("angularPayments").factory("Cards",[function(){var e=/(\d{1,4})/g,t=/(?:^|\s)(\d{4})$/,r=[{type:"mastercard",pattern:cc_patterns.mc,format:e,inputFormat:t,length:[16],cvcLength:[3],luhn:!0},{type:"amex",pattern:cc_patterns.amex,format:/(\d{1,4})(\d{1,6})?(\d{1,5})?/,inputFormat:/^(\d{4}|\d{4}\s\d{6})$/,length:[15],cvcLength:[4],luhn:!0},{type:"visa",pattern:cc_patterns.visa,format:e,inputFormat:t,length:[13,16,19],cvcLength:[3],luhn:!0}];return{fromNumber:function(e){return function(e){var t,n,a;for(e=(e+"").replace(/\D/g,""),n=0,a=r.length;n<a;n++)if((t=r[n]).pattern.test(e))return t}(e)},fromType:function(e){return function(e){var t,n,a;for(n=0,a=r.length;n<a;n++)if((t=r[n]).type===e)return t}(e)},defaultFormat:function(){return e},defaultInputFormat:function(){return t}}}]),angular.module("angularPayments").factory("_Format",["Cards","Common","$filter",function(e,t,r){var n={},a=function(e){var t;return null!==e.prop("selectionStart")&&e.prop("selectionStart")!==e.prop("selectionEnd")||!("undefined"==typeof document||null===document||null==(t=document.selection)||"function"!=typeof t.createRange||!t.createRange().text)},l=function(e){var t=String.fromCharCode(e.which);return!/^\d+$/.test(t)&&!(e.meta||e.metaKey)&&0!==e.charCode&&!e.ctrlKey},i=function(t){var r,n,a,i,u,o,s;a=String.fromCharCode(t.which),s=(r=angular.element(t.currentTarget)).val(),n=e.fromNumber(s+a),i=(s.replace(/\D/g,"")+a).length,o=16,8!==t.which&&0!==t.which&&(n&&(o=n.length[n.length.length-1]),l(t)?t.preventDefault():null!==r.prop("selectionStart")&&r.prop("selectionStart")!==s.length||(u=e.defaultInputFormat(),n&&(u=n.inputFormat),i>=o||(u.test(s)?(t.preventDefault(),r.val(s+" "+a).triggerHandler("input")):u.test(s+a)&&(t.preventDefault(),r.val(s+a+" ").triggerHandler("input")))))},u=function(t){var r,n,l,i;r=angular.element(t.currentTarget),l=String.fromCharCode(t.which),/^\d+$/.test(l)&&(c(r),a(r)||(i=(r.val()+l).replace(/\D/g,""),(n=e.fromNumber(i))?i.length>n.length[n.length.length-1]&&t.preventDefault():i.length>16&&t.preventDefault()))},o=function(e){var t,r;r=(t=angular.element(e.currentTarget)).val(),e.meta||e.metaKey||8===e.which&&(null!==t.prop("selectionStart")&&t.prop("selectionStart")!==r.length||(/\d\s$/.test(r)&&!e.meta&&!e.metaKey&&e.keyCode>=46?(e.preventDefault(),t.val(r.replace(/\d\s$/,"")).triggerHandler("input")):/\s\d?$/.test(r)&&(e.preventDefault(),t.val(r.replace(/\s\d?$/,"")).triggerHandler("input"))))},s=function(t){var r,n,a,l;return(r=e.fromNumber(t))?(a=r.length[r.length.length-1],t=(t=t.replace(/\D/g,"")).slice(0,+a+1||9e9),r.format.global?null!=(l=t.match(r.format))?l.join(" "):void 0:(null!=(n=r.format.exec(t))&&n.shift(),null!=n?n.join(" "):void 0)):t},c=function(e){return setTimeout(function(){var t,r;return r=(t=angular.element(e.target)).val(),r=s(r),t.val(r)})},p=function(e){return null!=e&&null!=e?e.replace(/\s/g,""):e};n.card=function(e,t){e.bind("keypress",u),e.bind("keypress",i),e.bind("keydown",o),e.bind("paste",c),t.$parsers.push(p),t.$formatters.push(s)};var f=function(e){var t,r;if(t=angular.element(e.currentTarget),r=String.fromCharCode(e.which),8!==e.which&&0!==e.which)if(l(e))e.preventDefault();else if(!a(t))return(t.val()+r).length<=4?void 0:void e.preventDefault()};n.cvc=function(e){e.bind("keypress",f)};var d=function(e){var t,r;t=angular.element(e.currentTarget),r=String.fromCharCode(e.which),l(e)?e.preventDefault():a(t)||(t.val()+r).replace(/\D/g,"").length>6&&e.preventDefault()},g=function(e){var t,r,n;if(r=String.fromCharCode(e.which),!l(e))return n=(t=angular.element(e.currentTarget)).val()+r,/^\d$/.test(n)&&"0"!==n&&"1"!==n?(e.preventDefault(),t.val("0"+n+" / ")):/^\d\d$/.test(n)?(e.preventDefault(),t.val(n+" / ")):void 0;e.preventDefault()},h=function(e){var t,r;if(!l(e))return r=(t=angular.element(e.currentTarget)).val(),/^\d\d$/.test(r)?t.val(r+" / "):void 0},m=function(e){var t,r;if("/"===String.fromCharCode(e.which))return r=(t=angular.element(e.currentTarget)).val(),/^\d$/.test(r)&&"0"!==r?t.val("0"+r+" / "):void 0},v=function(e){var t,r;if(!(e.meta||e.metaKey||(r=(t=angular.element(e.currentTarget)).val(),8!==e.which||null!==t.prop("selectionStart")&&t.prop("selectionStart")!==r.length)))return/\d(\s|\/)+$/.test(r)?(e.preventDefault(),t.val(r.replace(/\d(\s|\/)*$/,""))):/\s\/\s?\d?$/.test(r)?(e.preventDefault(),t.val(r.replace(/\s\/\s?\d?$/,""))):void 0},y=function(e){if(null!==e){var n=t.parseExpiry(e),a=new Date(n.year,n.month-1);return r("date")(a,"MM/yyyy")}return null},$=function(e){if(null!==e){var n=t.parseExpiry(e),a=new Date(n.year,n.month-1);return r("date")(a,"MM / yyyy")}return null};return n.expiry=function(e,t){e.bind("keypress",d),e.bind("keypress",g),e.bind("keypress",m),e.bind("keypress",h),e.bind("keydown",v),t.$parsers.push(y),t.$formatters.push($)},function(e,t,r){var a;if(!n[e])throw a='Unknown type for formatting: "'+e+'". ',a+='Should be one of: "'+Object.keys(n).join('", "')+'"';return n[e](t,r)}}]).directive("paymentsFormat",["$window","_Format",function(e,t){return{restrict:"A",require:"ngModel",link:function(e,r,n,a){t(n.paymentsFormat,r,a)}}}]),angular.module("angularPayments").factory("_Validate",["Cards","Common","$parse",function(e,t,r){var n=[].indexOf||function(e){for(var t=0,r=this.length;t<r;t++)if(t in this&&this[t]===e)return t;return-1},a={cvc:function(t,a,l,i){var u,o,s;if(!t)return!0;if(!/^\d+$/.test(t))return!1;if(i.paymentsTypeModel){var c=r(i.paymentsTypeModel),p=i.cardType;s=void 0===p?c(l):p}return s?(u=t.length,n.call(null!==(o=e.fromType(s))?o.cvcLength:void 0,u)>=0):t.length>=3&&t.length<=4}};return a.card=function(t,a,l,i){var u,o,s;i.paymentsTypeModel&&(s=r(i.paymentsTypeModel));var c=function(){s&&s.assign(l,null),a.$card=null};if(!t)return c(),!0;if(t=(t+"").replace(/\s+|-/g,""),!/^\d+$/.test(t))return c(),!1;if(!(u=e.fromNumber(t)))return c(),!1;a.$card=angular.copy(u),s&&s.assign(l,u.type);var p=u.length[u.length.indexOf(t.length)];return o=t.length,n.call(u.length,o)>=0&&t.length===p&&(!1===u.luhn||function(e){var t,r,n,a,l,i;for(n=!0,a=0,l=0,i=(r=(e+"").split("").reverse()).length;l<i;l++)t=r[l],t=parseInt(t,10),(n=!n)&&(t*=2),t>9&&(t-=9),a+=t;return a%10==0}(t))},a.expiry=function(e){var r,n,a,l,i;return!e||(r=(a=t.parseExpiry(e)).month,n=a.year,!(!r||!n)&&(!!/^\d+$/.test(r)&&(!!/^\d+$/.test(n)&&(!(parseInt(r,10)>12)&&(2===n.length&&(n=(new Date).getFullYear().toString().slice(0,2)+n),i=new Date(n,r),l=new Date,i.setMonth(i.getMonth()-1),i.setMonth(i.getMonth()+1,1),i>l)))))},function(e,t,r,n,l){var i;if(!a[e])throw i='Unknown type for validation: "'+e+'". ',i+='Should be one of: "'+Object.keys(a).join('", "')+'"';return a[e](t,r,n,l)}}]).factory("_ValidateWatch",["_Validate",function(e){var t={cvc:function(t,r,n,a){a.paymentsTypeModel&&n.$watch(a.paymentsTypeModel,function(l,i){if(l!==i){var u=e(t,r.$modelValue,r,n,a);r.$setValidity(t,u)}})}};return function(e,r,n,a){if(t[e])return t[e](e,r,n,a)}}]).directive("paymentsValidate",["$window","_Validate","_ValidateWatch",function(e,t,r){return{restrict:"A",require:"ngModel",link:function(e,n,a,l){var i=a.paymentsValidate;r(i,l,e,a);var u=function(r){var n=t(i,r,l,e,a);return l.$setValidity(i,n),n?r:void 0};l.$formatters.push(u),l.$parsers.push(u)}}}]).directive("paymentsLength",[function(){return{require:"ngModel",link:function(e,t,r,n){n.$parsers.push(function(e){if("card"===r.paymentsLength){var t="";n.$viewValue&&(t=n.$viewValue.replace(/\s/g,"")),n.$setValidity("length",t.length>=13)}return e})}}}]),angular.module("angularPayments").directive("stripeForm",["$window","$parse","Common",function(e,t,r){return{restrict:"A",link:function(t,n,a){if(!e.Stripe)throw"stripeForm requires that you have stripe.js installed. Include https://js.stripe.com/v2/ into your html.";var l=angular.element(n);l.bind("submit",function(){var n=!!t.expMonth,i=!!t.expYear;if(!n||!i){var u=r.parseExpiry(t.expiry);t.expMonth=u.month,t.expYear=u.year}var o=l.find("button");o.prop("disabled",!0),l.hasClass("ng-valid")?e.Stripe.createToken(function(e){var t,r=["number","expMonth","expYear","cvc","name","addressLine1","addressLine2","addressCity","addressState","addressZip","addressCountry"],n={};for(var a in r)e.hasOwnProperty(r[a])&&(n[(t=r[a],t.replace(/([A-Z])/g,function(e){return"_"+e.toLowerCase()}))]=angular.copy(e[r[a]]));return n.number=(n.number||"").replace(/ /g,""),n}(t),function(){var e=arguments;t.$apply(function(){t[a.stripeForm].apply(t,e)}),o.prop("disabled",!1)}):(t.$apply(function(){t[a.stripeForm].apply(t,[400,{error:"Invalid form submitted."}])}),o.prop("disabled",!1)),t.expMonth=null,t.expYear=null})}}}]);